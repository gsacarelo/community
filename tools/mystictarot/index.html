<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>🎴 Mystic Tarot</title>
<meta name="theme-color" content="#07080b">
<style>
  :root{
    --bg:#07080b;         /* darker base */
    --panel:#0f121b;
    --ink:#f7f9ff;        /* brighter text */
    --muted:#b8c0d9;
    --edge:#2a2f49;
    --hi:#86f7e7;         /* high-contrast accents */
    --hi2:#ff84d6;
    --hi3:#8f86ff;
    --good:#42e6a4;
    --bad:#ff6b88;
    --ring:0 0 0 3px rgba(134,247,231,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:15px/1.55 Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    overflow-x:hidden;
  }
  @media (prefers-reduced-motion: reduce){
    *{animation:none!important; transition:none!important}
  }

  /* Ambient background */
  #stars{position:fixed; inset:0; z-index:-3; display:block}
  .aurora{
    position:fixed; inset:0; z-index:-2; pointer-events:none;
    background:
      radial-gradient(1000px 700px at 70% -10%, rgba(143,134,255,.30), transparent 60%),
      radial-gradient(900px 900px at 20% 120%, rgba(134,247,231,.22), transparent 60%),
      radial-gradient(700px 700px at 90% 110%, rgba(255,132,214,.22), transparent 60%);
    animation:drift 24s ease-in-out infinite alternate;
  }
  @keyframes drift{from{transform:translateY(-1.5%) scale(1.02)}to{transform:translateY(1.5%) scale(1.04)}}

  .wrap{max-width:1120px; margin:0 auto; padding:18px}
  .header{
    display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    padding:12px 14px; background:linear-gradient(180deg,#161a2a,#0f121b);
    border:1px solid var(--edge); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .brand{display:flex; gap:12px; align-items:center}
  .sigil{width:36px; height:36px; border-radius:50%;
    background:
      radial-gradient(circle at 50% 55%, rgba(134,247,231,.95), rgba(134,247,231,.25) 55%, rgba(134,247,231,0) 70%),
      conic-gradient(from 0deg, rgba(255,132,214,.4), rgba(143,134,255,.35), rgba(134,247,231,.35), rgba(255,132,214,.4));
    box-shadow:0 0 24px rgba(134,247,231,.45), inset 0 0 14px rgba(255,255,255,.2);
  }
  .title{font-weight:800; letter-spacing:.4px;}
  .title small{display:block; color:var(--muted); font-weight:500; letter-spacing:.2px}
  .badge{padding:6px 10px; border-radius:999px; background:#12142a; color:#cfe6ff; border:1px solid #28305b}

  .view{margin-top:16px; background:linear-gradient(180deg,#14182a,#0f121b);
    border:1px solid var(--edge); border-radius:18px; padding:16px; box-shadow:inset 0 1px 0 rgba(255,255,255,.05)}
  #menuView{display:block}
  #readView{display:none}

  /* Controls */
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .input,.btn,.toggle{border-radius:12px; border:1px solid #556ad9; background:#0d1019; color:var(--ink); padding:10px 12px; outline:none}
  .input{min-width:260px; flex:1 1 260px}
  .input:focus{box-shadow:var(--ring); border-color:#255e57}
  .btn{
    cursor:pointer; font-weight:800; letter-spacing:.25px;
    background:linear-gradient(180deg, var(--hi), #4fdacb); border-color:#2fb1a4; color:#04211e;
    transition:filter .12s ease, transform .06s ease;
  }
  .btn.secondary{background:linear-gradient(180deg,#2a2f49,#1a1e33); border-color:#39406b; color:var(--ink)}
  .btn.ghost{background:transparent; border-color:#39406b; color:var(--ink)}
  .btn:active{transform:translateY(1px)}
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .toggle{display:flex; gap:8px; align-items:center; user-select:none; color:var(--muted)}
  .toggle input{accent-color:#56e6d7}

  /* Grid */
  .sectionTitle{font-weight:800; letter-spacing:.2px; margin:4px 2px 8px}
  .grid{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
  @media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:820px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:540px){ .grid{grid-template-columns:1fr} }

  /* Spread Cards */
  .spreadCard{
    text-align:left; border:1px solid #2a2f49; background:linear-gradient(180deg,#161a2f,#0f121b);
    border-radius:16px; padding:14px; cursor:pointer; position:relative; overflow:hidden;
    transition:transform .15s ease, border-color .15s ease, box-shadow .15s ease, outline-color .15s ease;
  }
  .spreadCard:hover{transform:translateY(-2px); border-color:#3a4da2; box-shadow:0 12px 28px rgba(0,0,0,.45)}
  .spreadCard.sel{outline:3px solid rgba(134,247,231,.55)}
  .spreadName{font-weight:800; font-size:16px}
  .spreadMeta{color:var(--muted); font-size:12px; margin-top:6px}
  .ribbon{
    position:absolute; right:-26px; top:10px; transform:rotate(24deg);
    background:linear-gradient(90deg,var(--hi2),var(--hi3)); color:#000000; font-weight:900;
    padding:6px 36px; border-radius:999px; font-size:12px; opacity:0.5;
  }
  .divider{height:1px; background:#2a2f49; margin:12px 0}

  /* Reading view */
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between}
  .status{color:var(--muted); font-size:13px}
  .chip{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #3a4da2; background:#121630}
  .chip.good{border-color:#1e5a4b; background:#0e1412; color:#baffea}
  .chip.bad{border-color:#5a1e36; background:#140e12; color:#ffc6da}

  .cards{display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-top:12px}
  @media (max-width:1100px){.cards{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:820px){ .cards{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:540px){ .cards{grid-template-columns:1fr} }

  /* Tarot card (flip) */
  .tarot{perspective:1100px; height:240px; position:relative}
  .inner{position:absolute; inset:0; transform-style:preserve-3d; transition:transform .7s cubic-bezier(.2,.8,.2,1)}
  .tarot.flipped .inner{transform:rotateY(180deg)}
  .face{
    position:absolute; inset:0; backface-visibility:hidden; border-radius:16px; border:1px solid #2a2f49; overflow:hidden;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.05), 0 12px 30px rgba(0,0,0,.45);
    display:flex; flex-direction:column; justify-content:center; padding:12px;
  }
  .front{
    align-items:center; text-align:center; gap:6px;
    background:
      radial-gradient(320px 160px at 50% 0%, rgba(255,255,255,.06), transparent 60%),
      repeating-conic-gradient(from 0deg, rgba(255,255,255,.06) 0 6deg, rgba(255,255,255,0) 6deg 12deg),
      linear-gradient(180deg,#182043,#0f121b);
  }
  .front .sig{width:68px; height:68px; border-radius:50%;
    background:
      radial-gradient(circle at 50% 55%, rgba(143,134,255,.95), rgba(143,134,255,.25) 55%, rgba(143,134,255,0) 70%),
      conic-gradient(from 0deg, rgba(255,132,214,.35), rgba(143,134,255,.35), rgba(134,247,231,.35), rgba(255,132,214,.35));
    box-shadow:0 0 26px rgba(143,134,255,.55), inset 0 0 18px rgba(255,255,255,.12);
    animation:pulse 3.2s ease-in-out infinite;
  }
  @keyframes pulse{50%{transform:scale(1.06)}}
  .front small{color:var(--muted)}
  .back{background:linear-gradient(180deg,#171c34,#0f121b); transform:rotateY(180deg)}
  .pos{align-self:flex-start; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #3a4da2; background:#121630}
  .pos.rev{border-color:#5a1e36; background:#140e12; color:#ffb3c5}
  .pos.up{border-color:#1e5a4b; background:#0e1412; color:#baffea}
  .cardTitle{font-weight:900; margin-top:8px; font-size:16px}
  .meta{color:var(--muted); font-size:12px; margin:4px 0 6px}
  .meaning{font-size:14px; display:-webkit-box; -webkit-line-clamp:4; line-clamp:4; -webkit-box-orient:vertical; overflow:hidden}
  .desc{color:#e5e8ff; font-size:13px; opacity:.9; margin-top:6px; display:none}
  .actions{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap}
  .mini{font-size:12px; padding:6px 10px; border-radius:10px; border:1px solid #39406b; background:#151a33; color:var(--ink); cursor:pointer}
  .mini:focus{outline:none; box-shadow:var(--ring)}

  /* Loading skeleton */
  .skeleton{height:240px; border-radius:16px; background:linear-gradient(90deg,#1a2146 25%, #222a59 37%, #1a2146 63%); background-size:400% 100%; animation:shimmer 1.1s infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .foot{margin-top:14px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; color:var(--muted)}
  .foot a{color:var(--hi); text-decoration:none} .foot a:hover{text-decoration:underline}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50}
  .modal.open{display:flex}
  .overlay{position:absolute; inset:0; background:rgba(0,0,0,.65)}
  .sheet{
    position:relative; width:min(720px,92vw); max-height:80vh; overflow:auto;
    background:linear-gradient(180deg,#14182a,#0f121b); border:1px solid var(--edge); border-radius:16px; padding:16px;
    box-shadow:0 30px 80px rgba(0,0,0,.6);
  }
  .sheet h3{margin:0 0 6px 0}
  .sheet .muted{color:var(--muted); font-size:13px}
  .sheet .close{position:absolute; right:10px; top:10px}
    
  /* === CUSTOM SPREAD BUTTON TEXT COLORS (override) === */
  .spreadCard .spreadName { color: #e2ecff; }   /* normal state */
  .spreadCard .spreadMeta { color: #9ad9ff; }   /* normal state (labels) */

  .spreadCard:hover .spreadName { color: #498fff; }  /* hover */
  .spreadCard:hover .spreadMeta { color: #58ff4b; }  /* hover */

  .spreadCard.sel .spreadName { color: #86f7e7; }    /* selected (after click) */
  .spreadCard.sel .spreadMeta { color: #dba8ff; }    /* selected (after click) */

  .siteFooter{
    margin-top:18px;
    padding:14px 16px;
    border:1px solid var(--edge);
    border-radius:14px;
    background:linear-gradient(180deg, #121528, #0d1019);
    color:var(--muted);
    display:flex; gap:8px; align-items:center; justify-content:center;
    font-size:13px; letter-spacing:.2px;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.05);
  }
  .siteFooter .heart{
    display:inline-block; margin:0 4px; font-size:14px; line-height:1;
    color:#ff7aa7; text-shadow:0 0 8px rgba(255,122,167,.6), 0 0 16px rgba(255,122,167,.35);
  }

  /* Pulsing footer heart */
  @keyframes heartPulse {
    0%   { transform: scale(1);     text-shadow: 0 0 6px rgba(255,122,167,.35), 0 0 12px rgba(255,122,167,.2); }
    50%  { transform: scale(1.2);  text-shadow: 0 0 10px rgba(255,122,167,.6), 0 0 22px rgba(255,122,167,.35); }
    100% { transform: scale(1);     text-shadow: 0 0 6px rgba(255,122,167,.35), 0 0 12px rgba(255,122,167,.2); }
  }
  .siteFooter .heart {
    animation: heartPulse 1.8s ease-in-out infinite;
  }
  @media (prefers-reduced-motion: reduce) {
    .siteFooter .heart { animation: none; }
  }

</style>
</head>
<body>
<canvas id="stars"></canvas>
<div class="aurora"></div>

<div class="wrap">
  <header class="header">
    <div class="brand">
      <div class="sigil" aria-hidden="true"></div>
      <div class="title">🎴 Mystic Tarot<small>What you ask, echoes back</small></div>
    </div>
    
  </header>

  <!-- MENU -->
  <section id="menuView" class="view" aria-label="Menu">
    <div class="sectionTitle">Choose your spread</div>
    <div id="spreadGrid" class="grid" role="listbox" aria-label="Spreads"></div>

    <div class="divider"></div>

    <div class="row">
      <input id="question" class="input" type="text" placeholder="Your question (optional)… e.g., What should I focus on next?" aria-label="Question"/>
      <label class="toggle"><input id="reversals" type="checkbox" checked/> Allow reversals</label>
      <label class="toggle"><input id="autoReveal" type="checkbox" checked/> Auto-reveal</label>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="startBtn" class="btn" disabled>Start Reading</button>
      <button id="randomBtn" class="btn secondary">Surprise me</button>
      <span class="status" id="menuHint">Pick a spread or hit “Surprise me”.</span>
    </div>
  </section>

  <!-- READING -->
  <section id="readView" class="view" aria-label="Reading" aria-live="polite">
    <div class="toolbar">
      <div class="row">
        <button id="backBtn" class="btn ghost" aria-label="Back to menu">← Back</button>
        <span id="questionEcho" class="chip" role="note"></span>
        <span id="status" class="status"></span>
      </div>
      <div class="row">
        <button id="drawBtn" class="btn">Shuffle & Draw</button>
        <button id="rerollBtn" class="btn secondary">Reroll</button>
        <button id="flipAllBtn" class="btn secondary">Flip all</button>
        <button id="copyBtn" class="btn secondary">Copy</button>
        <button id="saveBtn" class="btn secondary">Save .txt</button>
      </div>
    </div>

    <div id="loading" class="grid" style="margin-top:12px" hidden></div>
    <div id="cards" class="cards"></div>

    <div class="foot">
      <div>Tip: Tap a card to flip. Use <em>Allow reversals</em> in menu to disable inverted cards.</div>
      <div>If the app hiccups, wait for a minute.</div>
    </div>
  </section>
  <footer class="siteFooter" role="contentinfo">
    <span>Built with</span>
    <span class="heart" title="love">♥</span>
    <span>by Gerardo Sacarelo V.</span>
  </footer>

</div>

<!-- Details Modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="overlay" id="overlay"></div>
  <div class="sheet" role="dialog" aria-modal="true">
    <button class="btn secondary close" id="closeModal" aria-label="Close">✕</button>
    <h3 id="m_title">Card</h3>
    <div class="muted" id="m_pos">Position • Upright</div>
    <div class="muted" id="m_meta" style="margin:8px 0 12px"></div>
    <div><strong>Meaning:</strong> <span id="m_meaning"></span></div>
    <div style="margin-top:8px; white-space:pre-wrap" id="m_desc"></div>
  </div>
</div>

<script>
/* ===== Config ===== */
const API_RANDOM = n => `https://tarotapi.dev/api/v1/cards/random?n=${n}`;
const SPREADS = [
  { id:'one',  name:'1 — One answer, One truth', labels:['Insight'], badge:'Swift' },
  { id:'three',name:'3 — Balance & Direction', labels:['Past','Present','Future'], badge:'Classic' },
  { id:'five', name:'5 — Five Facets of your Path',
    labels:['Situation','Challenge','Advice','External','Outcome'], badge:'Deeper' },
  { id:'seven',name:'7 — Hidden Currents',
    labels:['Past','Present','Hidden','Obstacle','Others','Advice','Outcome'], badge:'Horseshoe' }
];
const FALLBACK = [
  {name:"The Fool", suit:"Major Arcana", type:"major", meaning_up:"Beginnings, innocence, free spirit", meaning_rev:"Recklessness, risk, naivety", desc:"Leap of faith; open potential."},
  {name:"The Magician", suit:"Major Arcana", type:"major", meaning_up:"Manifestation, resourcefulness, power", meaning_rev:"Manipulation, untapped talents", desc:"Channel will into form."},
  {name:"The High Priestess", suit:"Major Arcana", type:"major", meaning_up:"Intuition, mystery, inner voice", meaning_rev:"Disconnected intuition", desc:"The answer is beneath the surface."},
  {name:"The Empress", suit:"Major Arcana", type:"major", meaning_up:"Fertility, abundance, nurture", meaning_rev:"Dependence, stagnation", desc:"Grow what you care for."},
  {name:"The Emperor", suit:"Major Arcana", type:"major", meaning_up:"Structure, authority, stability", meaning_rev:"Rigidity, domination", desc:"Lead with clarity."},
  {name:"The Hierophant", suit:"Major Arcana", type:"major", meaning_up:"Tradition, learning, guidance", meaning_rev:"Rebellion, new paths", desc:"Root in wisdom; evolve the form."},
  {name:"The Lovers", suit:"Major Arcana", type:"major", meaning_up:"Union, values, choices", meaning_rev:"Misalignment, imbalance", desc:"Choose in alignment."}
];

/* ===== State ===== */
let chosenSpread = null;
let allowReversals = true;
let autoReveal = true;
let lastCards = [];
let lastMask = [];
let lastLabels = [];
let drawId = 0; // increments each draw to invalidate stale timeouts

/* ===== DOM ===== */
const menuView = document.getElementById('menuView');
const readView = document.getElementById('readView');
const spreadGrid = document.getElementById('spreadGrid');
const questionInput = document.getElementById('question');
const reversalsChk = document.getElementById('reversals');
const autoRevealChk = document.getElementById('autoReveal');
const startBtn = document.getElementById('startBtn');
const randomBtn = document.getElementById('randomBtn');

const statusEl = document.getElementById('status');
const loadingEl = document.getElementById('loading');
const cardsEl = document.getElementById('cards');
const questionEcho = document.getElementById('questionEcho');

const backBtn = document.getElementById('backBtn');
const drawBtn = document.getElementById('drawBtn');
const rerollBtn = document.getElementById('rerollBtn');
const flipAllBtn = document.getElementById('flipAllBtn');
const copyBtn = document.getElementById('copyBtn');
const saveBtn = document.getElementById('saveBtn');

/* Modal */
const modal = document.getElementById('modal');
const overlay = document.getElementById('overlay');
const closeModalBtn = document.getElementById('closeModal');
const mTitle = document.getElementById('m_title');
const mPos = document.getElementById('m_pos');
const mMeta = document.getElementById('m_meta');
const mMeaning = document.getElementById('m_meaning');
const mDesc = document.getElementById('m_desc');

/* ===== Init Spreads ===== */
function renderSpreads(){
  spreadGrid.innerHTML = '';
  SPREADS.forEach(sp=>{
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='spreadCard';
    btn.innerHTML = `<div class="ribbon">${sp.badge}</div>
      <div class="spreadName">${sp.name}</div>
      <div class="spreadMeta">${sp.labels.join(' · ')}</div>`;
    btn.addEventListener('click', ()=>{
      [...spreadGrid.children].forEach(c=>c.classList.remove('sel'));
      btn.classList.add('sel');
      chosenSpread = sp;
      startBtn.disabled = false;
    });
    spreadGrid.appendChild(btn);
  });
}
renderSpreads();

/* ===== Helpers ===== */
function setLoading(v, count=3){
  loadingEl.hidden = !v;
  statusEl.textContent = v ? 'Shuffling deck…' : '';
  if(v){
    loadingEl.innerHTML = '';
    for(let i=0;i<count;i++){
      const sk = document.createElement('div');
      sk.className='skeleton';
      loadingEl.appendChild(sk);
    }
  }else{
    loadingEl.innerHTML = '';
  }
}
function escapeHtml(str){
  return String(str??'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}
function playChime(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(528, ctx.currentTime);
    g.gain.setValueAtTime(0.001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.06, ctx.currentTime+0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.5);
    o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.52);
  }catch(e){}
}

/* ===== Modal ===== */
function openModal(card, posText, metaText, meaning, desc){
  mTitle.textContent = card?.name || 'Card';
  mPos.textContent = posText;
  mMeta.textContent = metaText;
  mMeaning.textContent = meaning;
  mDesc.textContent = desc || '';
  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
  closeModalBtn.focus();
}
function closeModal(){
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden','true');
}
overlay.addEventListener('click', closeModal);
closeModalBtn.addEventListener('click', closeModal);
document.addEventListener('keydown', e=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeModal(); });

/* ===== Build a card element ===== */
function buildCardEl(card, label, reversed){
  const el = document.createElement('div');
  el.className='tarot';
  el.innerHTML = `
    <div class="inner">
      <div class="face front" aria-label="Card back">
        <div class="sig" aria-hidden="true"></div>
        <div><small>${escapeHtml(label)}</small></div>
        <small style="color:var(--muted)">Tap to reveal</small>
      </div>
      <div class="face back" aria-label="Card face">
        <span class="pos ${reversed?'rev':'up'}">${escapeHtml(label)} • ${reversed?'Reversed':'Upright'}</span>
        <div class="cardTitle">${escapeHtml(card.name || 'Unknown')}</div>
        <div class="meta">${escapeHtml(card.suit || (card.type&&/major/i.test(card.type)?'Major Arcana':'—'))}${card.type?` • ${escapeHtml(card.type)}`:''}</div>
        <div class="meaning"><strong>Meaning:</strong> ${escapeHtml(reversed ? (card.meaning_rev || card.meaning_reverse || '—') : (card.meaning_up || card.meaning || '—'))}</div>
        <div class="actions">
          <button class="mini" type="button">Details</button>
        </div>
      </div>
    </div>`;
  // flip on click
  el.addEventListener('click', (ev)=>{
    // avoid flipping when pressing inner buttons
    if(ev.target.closest('.mini')) return;
    el.classList.toggle('flipped');
    playChime();
  });
  // details button
  el.querySelector('.mini').addEventListener('click', (ev)=>{
    ev.stopPropagation();
    const posText = `${label} • ${reversed?'Reversed':'Upright'}`;
    const meta = `${card.suit || (card.type&&/major/i.test(card.type)?'Major Arcana':'—')}${card.type?` • ${card.type}`:''}`;
    const meaning = reversed ? (card.meaning_rev || card.meaning_reverse || '—') : (card.meaning_up || card.meaning || '—');
    const desc = card.desc || card.description || '';
    openModal(card, posText, meta, meaning, desc);
  });
  return el;
}

/* ===== Render cards safely ===== */
function renderCards(cards, labels){
  cardsEl.innerHTML = '';
  cards.forEach((c,i)=>{
    const el = buildCardEl(c, labels[i] || `Card ${i+1}`, lastMask[i]);
    el.style.transform='translateY(18px) scale(.985)'; el.style.opacity='0';
    cardsEl.appendChild(el);
  });
  // staggered entrance (guard with drawId)
  const current = drawId;
  [...cardsEl.children].forEach((el, idx)=>{
    setTimeout(()=>{
      if(current !== drawId) return; // stale animation -> abort
      el.style.transition='transform .45s cubic-bezier(.2,.8,.2,1), opacity .45s ease';
      el.style.transform='translateY(0) scale(1)';
      el.style.opacity='1';
    }, 60*idx);
  });
}

/* ===== Draw flow with ghost-guard ===== */
async function drawOnce(){
  if(!chosenSpread) return;
  const myId = ++drawId; // new draw started
  const n = chosenSpread.labels.length;

  // Reset UI for this draw
  cardsEl.innerHTML = '';
  setLoading(true, Math.min(4, n));
  statusEl.textContent = 'Shuffling deck…';

  // Fetch
  try{
    const res = await fetch(API_RANDOM(n), {mode:'cors'});
    if(myId !== drawId) return; // another draw started; abort
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    const cards = Array.isArray(data) ? data : (data.cards || []);
    if(!cards.length) throw new Error('Empty deck');
    lastCards = cards.slice(0,n);
    statusEl.innerHTML = `<span class="chip good">Pulled ${n} card${n>1?'s':''} from tarotapi.dev</span>`;
  }catch(e){
    if(myId !== drawId) return;
    lastCards = FALLBACK.slice(0, n);
    statusEl.innerHTML = `<span class="chip bad">API unavailable — using fallback deck</span>`;
  }finally{
    if(myId !== drawId) return;
    setLoading(false);
  }

  // Reversal mask & labels
  lastMask = Array.from({length:lastCards.length}, ()=> allowReversals ? Math.random()<0.5 : false);
  lastLabels = chosenSpread.labels.slice();

  // Render
  if(myId !== drawId) return;
  renderCards(lastCards, lastLabels);

  // Auto reveal (guarded)
  if(autoReveal){
    const nodes = [...cardsEl.children];
    nodes.forEach((node, i)=> setTimeout(()=>{
      if(myId !== drawId) return;
      node.classList.add('flipped'); playChime();
    }, 520 + i*360));
  }

  // Echo question
  const q = questionInput.value.trim();
  questionEcho.textContent = q ? `Question: “${q}”` : '';
}

/* ===== Actions ===== */
startBtn.addEventListener('click', ()=>{
  if(!chosenSpread) return;
  menuView.style.display='none';
  readView.style.display='block';
  drawOnce();
});
randomBtn.addEventListener('click', ()=>{
  const i = Math.floor(Math.random()*SPREADS.length);
  chosenSpread = SPREADS[i];
  [...spreadGrid.children].forEach(c=>c.classList.remove('sel'));
  spreadGrid.children[i]?.classList.add('sel');
  startBtn.disabled = false;
});
backBtn.addEventListener('click', ()=>{
  // invalidate any pending animations/timeouts
  drawId++;
  readView.style.display='none';
  menuView.style.display='block';
  statusEl.textContent='';
  questionEcho.textContent='';
  cardsEl.innerHTML='';
  setLoading(false);
});
drawBtn.addEventListener('click', drawOnce);
rerollBtn.addEventListener('click', drawOnce);
flipAllBtn.addEventListener('click', ()=>{
  [...cardsEl.children].forEach(el=> el.classList.toggle('flipped'));
  playChime();
});
copyBtn.addEventListener('click', ()=>{
  const q = questionInput.value.trim();
  const lines = [...cardsEl.querySelectorAll('.tarot')].map((el,i)=>{
    const name = el.querySelector('.cardTitle')?.textContent || '';
    const pos = `${lastLabels[i]} • ${lastMask[i] ? 'Reversed' : 'Upright'}`;
    const meaning = (el.querySelector('.meaning')?.textContent || '').replace(/^Meaning:\s*/,'').trim();
    return `• ${name} — ${pos}\n  Meaning: ${meaning}`;
  }).join('\n');
  const txt = `${q?`Question: ${q}\n`:''}${lines}\n— via tarotapi.dev`;
  navigator.clipboard.writeText(txt).then(()=>{
    statusEl.innerHTML = `<span class="chip good">Copied reading</span>`;
  }).catch(()=> statusEl.innerHTML = `<span class="chip bad">Clipboard blocked — copy manually</span>`);
});
saveBtn.addEventListener('click', ()=>{
  const q = questionInput.value.trim();
  const now = new Date().toISOString().replace(/[:T]/g,'-').slice(0,16);
  const lines = lastCards.map((c,i)=>{
    const pos = `${lastLabels[i]} • ${lastMask[i] ? 'Reversed' : 'Upright'}`;
    const meaning = lastMask[i] ? (c.meaning_rev || c.meaning_reverse || '—') : (c.meaning_up || c.meaning || '—');
    const desc = c.desc || c.description || '';
    return `• ${c.name} — ${pos}\n  Meaning: ${meaning}${desc?`\n  Note: ${desc}`:''}`;
  }).join('\n');
  const txt = `MYSTIC TAROT — Reading @ ${now}\n${q?`Question: ${q}\n`:''}${lines}\n— via tarotapi.dev\n`;
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `tarot_reading_${now}.txt`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
});

/* Options */
reversalsChk.addEventListener('change', ()=> allowReversals = reversalsChk.checked);
autoRevealChk.addEventListener('change', ()=> autoReveal = autoRevealChk.checked);

/* ===== Starfield ===== */
(function starfield(){
  const c = document.getElementById('stars');
  const ctx = c.getContext('2d');
  function resize(){ c.width = innerWidth; c.height = innerHeight; }
  addEventListener('resize', resize, {passive:true}); resize();
  const N = 170;
  const stars = Array.from({length:N}, ()=>({
    x: Math.random()*c.width, y: Math.random()*c.height, r: Math.random()*1.5 + 0.2,
    a: Math.random()*Math.PI*2, s: Math.random()*0.6 + 0.2
  }));
  function tick(){
    ctx.clearRect(0,0,c.width,c.height);
    for(const st of stars){
      st.a += 0.015*st.s;
      const alpha = 0.45 + Math.sin(st.a)*0.35;
      ctx.beginPath(); ctx.fillStyle = `rgba(200,220,255,${alpha})`;
      ctx.arc(st.x, st.y, st.r, 0, Math.PI*2); ctx.fill();
    }
    requestAnimationFrame(tick);
  }
  tick();
})();

/* Boot */
(() => { allowReversals = reversalsChk.checked; autoReveal = autoRevealChk.checked; })();
</script>
</body>
</html>
