<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‚òØÔ∏è Inner Weather</title>
<style>
  :root{
    --bg:#0b0d11; --card:#101422; --text:#eef2f9; --muted:#9aa3b2;
    --a:#8b5cf6; --b:#22d3ee; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    --grid:#1f2638; --line:#334155; --chip:#0f1320;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1100px 1100px at 8% -15%,#161b2a 10%,transparent 55%),var(--bg);color:var(--text);
       font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Segoe UI Emoji;}
  .wrap{max-width:1040px;margin:0 auto;padding:clamp(12px,2vw,18px)}
  header{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:10px; margin-bottom:10px; text-align:center;
  }
  h1{ margin:0; font-size:clamp(20px,3vw,28px); font-weight:850; text-align:center }
  .sub{ color:var(--muted); font-size:13px; margin-top:2px; text-align:center }

  .logo{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 190deg,var(--a),var(--b));
        filter:drop-shadow(0 8px 18px rgba(139,92,246,.28));animation:spin 9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  h1{margin:0;font-size:clamp(20px,3vw,28px);font-weight:850}
  .sub{color:var(--muted);font-size:13px;margin-top:2px}

  .grid{display:grid;gap:10px;grid-template-columns:1fr}
  @media(min-width:920px){.grid{grid-template-columns:420px 1fr}}

  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));
        border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:12px;position:relative;overflow:hidden}
  .card::after{content:"";position:absolute;inset:-1px;background:
     radial-gradient(380px 150px at var(--x,120%) -20%,rgba(139,92,246,.12),transparent 60%);
     pointer-events:none;transition:.25s}
  .card:hover::after{--x:80%}
  .title{display:flex;align-items:center;gap:8px;margin:0 0 8px 0;font-weight:800}
  .pill{font-size:11px;padding:2px 8px;border-radius:999px;background:rgba(139,92,246,.14);
        border:1px solid rgba(139,92,246,.34);color:#d6c7ff}

  .row{display:flex;gap:8px;flex-wrap:wrap}
  .field{flex:1 1 150px;min-width:150px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input,select{width:100%;background:#0f121b;color:var(--text);border:1px solid rgba(255,255,255,.08);
               padding:9px 10px;border-radius:10px;outline:none}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button{background:linear-gradient(90deg,var(--a),var(--b));color:white;border:0;border-radius:10px;
         padding:9px 12px;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(139,92,246,.28);
         transition:transform .12s ease, box-shadow .12s ease; font-size:14px;
         display:inline-flex; align-items:center; gap:8px; text-decoration:none;}
  .btn:hover, button:hover{ transform:translateY(-1px); box-shadow:0 10px 24px rgba(139,92,246,.34) }
  .btn.ghost, button.ghost{ background:#0f121b; border:1px solid rgba(255,255,255,.08); box-shadow:none; color:var(--text) }

  .kcol{display:grid;gap:8px;grid-template-columns:1fr}
  @media(min-width:560px){.kcol{grid-template-columns:repeat(2,1fr)}}
  .k{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:10px}
  .k h4{margin:0 0 2px 0;font-size:12px;color:var(--muted);font-weight:700}
  .k .v{font-size:16px;font-weight:800;line-height:1.25}
  .k .s{font-size:12px;color:var(--muted);margin-top:4px}

  .list{display:grid;gap:8px}
  .item{display:flex;gap:10px;justify-content:space-between;background:#0f121b;border:1px solid rgba(255,255,255,.08);
        border-radius:10px;padding:10px}
  .date{font-weight:800}
  .chip{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:var(--chip)}
  .good{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12);color:#c7f7d4}
  .bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12);color:#ffd2d2}
  .crit{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#ffe7b6}
  .mut{color:var(--muted);font-size:12px}

  /* Charts */
  .chart{background:#0f1320;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:8px}
  .chart h4{margin:0 0 6px 2px;font-size:12px;color:var(--muted);font-weight:700}
  svg{width:100%;height:230px;display:block}
  .gridline{stroke:var(--grid);stroke-width:1;opacity:.7}
  .axis{stroke:#55627a;stroke-width:1}
  .seriesA{fill:none;stroke:#60a5fa;stroke-width:2}
  .seriesB{fill:none;stroke:#34d399;stroke-width:2}
  .seriesC{fill:none;stroke:#f472b6;stroke-width:2}
  .today{stroke:#cbd5e1;stroke-width:2;stroke-dasharray:5 5}
  .zero{stroke:#475569;stroke-width:1}
  .marker{fill:#e2e8f0;stroke:#0f1320;stroke-width:1}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin:6px 4px 0 2px}
  .lg{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#b6c0cf}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.a{background:#60a5fa}.dot.b{background:#34d399}.dot.c{background:#f472b6}
  .tlabel{fill:#9aa4b2;font-size:11px}
  .footer{margin-top:10px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>‚òØÔ∏è Inner Weather</h1>
      <div class="sub">General ‚Ä¢ Today ‚Ä¢ Bio charts ‚Ä¢ Critical days</div>
    </div>
  </header>

  <!-- Inputs -->
  <section class="card">
    <h3 class="title">Your Data <span class="pill">Input</span></h3>
    <div class="row">
      <div class="field">
        <label for="dob">Birth date</label>
        <input id="dob" type="date" value="1990-11-07" required>
      </div>
      <div class="field">
        <label for="tob">Birth time (optional)</label>
        <input id="tob" type="time" value="12:00">
      </div>
      <div class="field">
        <label for="tz">Birth timezone offset (UTC¬±h)</label>
        <select id="tz"></select>
        <div class="mut" id="tzHint"></div>
      </div>
    </div>
    <div class="actions">
      <button id="useBrowser">Use my current timezone</button>
      <button id="run">Compute ‚ö°</button>
      <button class="ghost" id="toggleExp">Toggle explanations</button>
      <button type="button" class="ghost" onclick="window.location.href='../../index.html'" aria-label="Go to main page">‚üµ Main Page</button>
    </div>
  </section>

  <div class="grid">
    <!-- General -->
    <section class="card" id="general">
      <h3 class="title">General <span class="pill">Static</span></h3>
      <div class="kcol" id="kpiGeneral"></div>
    </section>

    <!-- Today -->
    <section class="card" id="today">
      <h3 class="title">Today <span class="pill">Live</span></h3>
      <div class="kcol" id="kpiToday"></div>

      <div class="chart" id="chartA">
        <h4>Physical ‚Ä¢ Emotional ‚Ä¢ Intellectual (‚àí7 ‚Üí +21 days)</h4>
        <svg id="svgA"></svg>
        <div class="legend">
          <span class="lg"><span class="dot a"></span>Physical</span>
          <span class="lg"><span class="dot b"></span>Emotional</span>
          <span class="lg"><span class="dot c"></span>Intellectual</span>
        </div>
      </div>

      <div class="chart" id="chartB" style="margin-top:8px">
        <h4>Intuition ‚Ä¢ Aesthetic ‚Ä¢ Spiritual (‚àí7 ‚Üí +21 days)</h4>
        <svg id="svgB"></svg>
        <div class="legend">
          <span class="lg"><span class="dot a"></span>Intuition</span>
          <span class="lg"><span class="dot b"></span>Aesthetic</span>
          <span class="lg"><span class="dot c"></span>Spiritual</span>
        </div>
      </div>
    </section>

    <!-- Next Critical -->
    <section class="card" id="critical">
      <h3 class="title">Next Critical Days <span class="pill">90 days</span></h3>
      <div class="list" id="critList"></div>
      <div class="mut" style="margin-top:6px">Shown only when multiple signals stack. Sorted by date.</div>
    </section>
  </div>

  <div class="footer">Built with ‚ù§Ô∏è by Gerardo Sacarelo V.</div>
</div>

<script>
/* ====== Helpers ====== */
const $ = s => document.querySelector(s);
const add = html => { const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild; };
const fmt = n => n.toLocaleString();

/* ====== Timezone select (‚àí12 ‚Üí +14 step 0.5) ====== */
(function buildTZ(){
  const sel = $('#tz'); sel.innerHTML = '';
  for(let h=-24; h<=28; h++){ // half-hour steps
    const v = (h/2).toFixed(1).replace(/\.0$/,'');
    const lab = `UTC${(h/2)>=0?'+':''}${v}`;
    const opt = document.createElement('option'); opt.value=v; opt.textContent=lab; sel.appendChild(opt);
  }
  sel.value='-5'; // default for Guayaquil
  $('#tzHint').textContent = `Using ${sel.value.startsWith('-')?'UTC':''}${sel.value.startsWith('-')?'': 'UTC+'}${sel.value}`;
})();

/* ====== Numerics ====== */
function reduceNum(n){
  let s = String(n).split('').map(Number).reduce((a,b)=>a+b,0);
  while(s>9 && s!==11 && s!==22 && s!==33){ s = String(s).split('').map(Number).reduce((a,b)=>a+b,0); }
  return s;
}
function jdFromGregorian(y,m,d){
  const a=Math.floor((14-m)/12), y2=y+4800-a, m2=m+12*a-3;
  return d + Math.floor((153*m2 + 2)/5) + 365*y2 + Math.floor(y2/4) - Math.floor(y2/100) + Math.floor(y2/400) - 32045;
}

/* ====== Western (date-only) ====== */
function sunSignDecan(m,d){
  const sign = ((m===10&&d>=23)||(m===11&&d<=21))?'Scorpio':'Other';
  if(sign==='Scorpio'){
    if((m===10&&d>=23)||(m===11&&d<=1)) return {sign:'Scorpio', decan:'1st (Mars)', meaning:'drive & direct action', element:'Water', modality:'Fixed'};
    if(d<=11) return {sign:'Scorpio', decan:'2nd (Jupiter)', meaning:'depth + strategic expansion', element:'Water', modality:'Fixed'};
    return {sign:'Scorpio', decan:'3rd (Moon)', meaning:'emotive focus & intuition', element:'Water', modality:'Fixed'};
  }
  return {sign:'‚Äî', decan:'‚Äî', meaning:'‚Äî', element:'‚Äî', modality:'‚Äî'};
}

/* ====== Chinese Zodiac (year) ====== */
function chineseZodiac(year){
  const animals=['Rat','Ox','Tiger','Rabbit','Dragon','Snake','Horse','Goat','Monkey','Rooster','Dog','Pig'];
  const stemsName=['Jia','Yi','Bing','Ding','Wu','Ji','Geng','Xin','Ren','Gui'];
  const stemsElem=['Wood (Yang)','Wood (Yin)','Fire (Yang)','Fire (Yin)','Earth (Yang)','Earth (Yin)','Metal (Yang)','Metal (Yin)','Water (Yang)','Water (Yin)'];
  const idxB=(year-4)%12, idxS=(year-4)%10;
  const animal=animals[(idxB+12)%12], stem=stemsName[(idxS+10)%10], stemElem=stemsElem[(idxS+10)%10];
  const elementSimple=['Wood','Wood','Fire','Fire','Earth','Earth','Metal','Metal','Water','Water'][(year-4)%10];
  const trait={Wood:'growth & ideals',Fire:'charisma & action',Earth:'stability & pragmatism',Metal:'resolve & precision',Water:'adaptability & insight'}[elementSimple];
  return {animal, element:elementSimple, yearPillar:`${stem}‚Äì${animal}`, meaning:`${elementSimple}: ${trait}`};
}

/* ====== Nine Star Ki (year-based; Feb 4 cutoff) ====== */
function nineStarKi(year,month,day){
  let y=year; if(month<2 || (month===2&&day<4)) y=year-1;
  const n=((y-1900)%9+9)%9||9;
  const element={1:'Water',2:'Earth',3:'Wood',4:'Wood',5:'Earth',6:'Metal',7:'Metal',8:'Earth',9:'Fire'}[n];
  const tip={1:'flow & networking',2:'stability & care',3:'initiate & start',4:'learn & expand',5:'reset & center',6:'structure & lead',7:'social & enjoy',8:'build patiently',9:'be visible & inspire'}[n];
  return {number:n, element, meaning:tip, note:'If born near Feb 3‚Äì5, some schools shift to previous year.'};
}

/* ====== Saju (Year Pillar only) ====== */
function sajuYearPillar(year){
  const cz = chineseZodiac(year);
  return {yearPillar:cz.yearPillar, meaning:`Year energy: ${cz.meaning}`};
}

/* ====== Mayan (GMT 584283) ====== */
function mayanFromGregorian(y,m,d){
  const JDN=jdFromGregorian(y,m,d), base=584283;
  const tzNum=((JDN-base+3)%13+13)%13+1;
  const tzNames=['Imix','Ik‚Äô','Ak‚Äôbal','K‚Äôan','Chikchan','Kimi','Manik‚Äô','Lamat','Muluk','Ok','Chuwen','Eb‚Äô','B‚Äôen','Ix','Men','Kib‚Äô','Kaban','Etz‚Äônab‚Äô','Kawak','Ajaw'];
  const tzName=tzNames[((JDN-base+19)%20+20)%20];
  const haabMonths=['Pop','Wo‚Äô','Sip','Sotz‚Äô','Sek','Xul','Yaxk‚Äôin','Mol','Ch‚Äôen','Yax','Sak‚Äô','Keh','Mak','K‚Äôank‚Äôin','Muwan‚Äô','Pax','K‚Äôayab','Kumk‚Äôu','Wayeb‚Äô'];
  const hi=((JDN-base+348)%365+365)%365; let hm=Math.floor(hi/20), hd=hi%20; if(hi>=360){hm=18;hd=hi-360;}
  return {tzolkin:`${tzNum} ${tzName}`, haab:`${hd} ${haabMonths[hm]}`};
}

/* ====== Moon ====== */
function moonPhaseInfo(dateUTC){
  const syn=29.530588, ref=Date.UTC(2000,0,6,18,14,0);
  const days=(dateUTC.getTime()-ref)/86400000, age=((days%syn)+syn)%syn;
  const illum=Math.round(50*(1 - Math.cos(2*Math.PI*age/syn)))*2;
  let phase='New üåë';
  if(age<1.84566) phase='New üåë';
  else if(age<5.53699) phase='Waxing Crescent üåí';
  else if(age<9.22831) phase='First Quarter üåì';
  else if(age<12.91963) phase='Waxing Gibbous üåî';
  else if(age<16.61096) phase='Full üåï';
  else if(age<20.30228) phase='Waning Gibbous üåñ';
  else if(age<23.99361) phase='Last Quarter üåó';
  else if(age<27.68493) phase='Waning Crescent üåò';
  else phase='New üåë';
  return {phase, illumination:illum, age};
}
function bornMoonPhase(y,m,d){
  return moonPhaseInfo(new Date(Date.UTC(y,m-1,d)));
}

/* ====== Biorhythms ====== */
const PERIODS={Physical:23,Emotional:28,Intellectual:33,Intuition:38,Aesthetic:43,Spiritual:53};
const bioVal=(d,p)=>Math.sin(2*Math.PI*d/p);
const classify=v=>Math.abs(v)<0.02?'critical':v>0.85?'high':v<-0.85?'low':'';

/* ====== Numerology ====== */
const tarotMap={1:"I ‚Ä¢ The Magician",2:"II ‚Ä¢ The High Priestess",3:"III ‚Ä¢ The Empress",4:"IV ‚Ä¢ The Emperor",5:"V ‚Ä¢ The Hierophant",6:"VI ‚Ä¢ The Lovers",7:"VII ‚Ä¢ The Chariot",8:"VIII ‚Ä¢ Strength",9:"IX ‚Ä¢ The Hermit",10:"X ‚Ä¢ Wheel of Fortune",11:"XI ‚Ä¢ Justice",12:"XII ‚Ä¢ The Hanged Man",13:"XIII ‚Ä¢ Death",14:"XIV ‚Ä¢ Temperance",15:"XV ‚Ä¢ The Devil",16:"XVI ‚Ä¢ The Tower",17:"XVII ‚Ä¢ The Star",18:"XVIII ‚Ä¢ The Moon",19:"XIX ‚Ä¢ The Sun",20:"XX ‚Ä¢ Judgement",21:"XXI ‚Ä¢ The World",22:"0/XXII ‚Ä¢ The Fool"};
function lifePath(yyyy,mm,dd){const total=(String(yyyy)+String(mm).padStart(2,'0')+String(dd).padStart(2,'0')).split('').map(Number).reduce((a,b)=>a+b,0);return reduceNum(total);}
function tarotCards(yyyy,mm,dd){let t=(yyyy+mm+dd).toString().split('').map(Number).reduce((a,b)=>a+b,0);if(t>22)t=t.toString().split('').map(Number).reduce((a,b)=>a+b,0);const c=t.toString().split('').map(Number).reduce((a,b)=>a+b,0);return {primary:tarotMap[t], companion:tarotMap[c]};}
function numerologyDay(y,m,d,cy,cm,cd){const UY=reduceNum(cy), PY=reduceNum(m+d+UY), PM=reduceNum(PY+cm), PD=reduceNum(PM+cd);
  const yearTip={1:'start clean things',2:'build partnerships',3:'express + market',4:'systemize & build',5:'change & explore',6:'responsibilities/home',7:'study & refine',8:'execute/decide',9:'finish & release'}[PY];
  const dayTip={1:'initiate',2:'cooperate',3:'present',4:'organize',5:'adapt',6:'care/repair',7:'analyze',8:'negotiate/close',9:'wrap/let go'}[PD];
  return {UY,PY,PM,PD,yearTip,dayTip};
}

/* ====== Insight: Cycle Resonance Score ====== */
function resonance(vals){
  // share of cycles with same sign as top magnitude; + a bonus if Physical+Intellectual share sign
  const arr=Object.entries(vals).map(([k,v])=>({k,v,mag:Math.abs(v),sg:Math.sign(v)})).sort((a,b)=>b.mag-a.mag);
  const topSign=arr[0].sg||1;
  const aligned=arr.filter(x=>Math.sign(x.v)===topSign).length;
  const score=Math.round(100*aligned/arr.length);
  let tip = topSign>0? 'push/launch bias' : 'recovery/iterate bias';
  if(Math.sign(vals.Physical)===Math.sign(vals.Intellectual) && Math.abs(vals.Physical)>0.4 && Math.abs(vals.Intellectual)>0.4) tip += ' ‚Ä¢ body+mind sync';
  return {score, direction: topSign>0?'expansive':'consolidating', tip};
}

/* ====== Charts (SVG) ====== */
function renderChart(svg, seriesList){
  const W=svg.clientWidth||svg.parentElement.clientWidth, H=230, pad={l:36,r:8,t:10,b:26};
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`); svg.innerHTML='';
  const xMin=-7, xMax=21, yMin=-1, yMax=1;
  const X=x=>pad.l + ((x - xMin)/(xMax - xMin))*(W - pad.l - pad.r);
  const Y=y=>pad.t + (1 - ((y - yMin)/(yMax - yMin)))*(H - pad.t - pad.b);

  // grid lines
  const g=document.createElementNS('http://www.w3.org/2000/svg','g');
  [-1,-0.5,0,0.5,1].forEach(v=>{
    const l=document.createElementNS('http://www.w3.org/2000/svg','line');
    l.setAttribute('x1',X(xMin)); l.setAttribute('x2',X(xMax)); l.setAttribute('y1',Y(v)); l.setAttribute('y2',Y(v)); l.setAttribute('class','gridline'); g.appendChild(l);
    const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',4); t.setAttribute('y',Y(v)+4);
    t.setAttribute('class','tlabel'); t.textContent = (v*100).toFixed(0);
    svg.appendChild(t);
  });
  [-7,0,7,14,21].forEach(v=>{
    const l=document.createElementNS('http://www.w3.org/2000/svg','line');
    l.setAttribute('x1',X(v)); l.setAttribute('x2',X(v)); l.setAttribute('y1',Y(yMin)); l.setAttribute('y2',Y(yMax)); l.setAttribute('class','gridline'); g.appendChild(l);
    const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',X(v)-6); t.setAttribute('y',H-6);
    t.setAttribute('class','tlabel'); t.textContent = v;
    svg.appendChild(t);
  });
  svg.appendChild(g);

  // zero and today
  const zero=document.createElementNS('http://www.w3.org/2000/svg','line');
  zero.setAttribute('x1',X(xMin)); zero.setAttribute('x2',X(xMax)); zero.setAttribute('y1',Y(0)); zero.setAttribute('y2',Y(0)); zero.setAttribute('class','zero'); svg.appendChild(zero);
  const today=document.createElementNS('http://www.w3.org/2000/svg','line');
  today.setAttribute('x1',X(0)); today.setAttribute('x2',X(0)); today.setAttribute('y1',Y(yMin)); today.setAttribute('y2',Y(yMax)); today.setAttribute('class','today'); svg.appendChild(today);
  const tl=document.createElementNS('http://www.w3.org/2000/svg','text'); tl.setAttribute('x',X(0)+4); tl.setAttribute('y',Y(1)-6); tl.setAttribute('class','tlabel'); tl.textContent='today'; svg.appendChild(tl);

  // series paths + markers every 2 days + critical markers near zero-cross
  const classes=['seriesA','seriesB','seriesC'];
  seriesList.forEach((s,i)=>{
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    const d=s.data.map((p,idx)=>`${idx===0?'M':'L'} ${X(p.x)} ${Y(p.y)}`).join(' ');
    path.setAttribute('d',d); path.setAttribute('class',classes[i%3]); svg.appendChild(path);

    s.data.forEach(p=>{
      if(p.x%2===0){
        const mk=document.createElementNS('http://www.w3.org/2000/svg','circle');
        mk.setAttribute('cx',X(p.x)); mk.setAttribute('cy',Y(p.y)); mk.setAttribute('r',2.4); mk.setAttribute('class','marker'); svg.appendChild(mk);
      }
      if(Math.abs(p.y)<0.02){ // critical marker
        const cm=document.createElementNS('http://www.w3.org/2000/svg','circle');
        cm.setAttribute('cx',X(p.x)); cm.setAttribute('cy',Y(p.y)); cm.setAttribute('r',3.3); cm.setAttribute('fill','#fbbf24'); cm.setAttribute('stroke','#0f1320'); cm.setAttribute('stroke-width','1'); svg.appendChild(cm);
      }
    });
  });

  // simple tooltip
  const tip=document.createElementNS('http://www.w3.org/2000/svg','text');
  tip.setAttribute('class','tlabel'); tip.setAttribute('text-anchor','start'); svg.appendChild(tip);
  svg.addEventListener('mousemove',(e)=>{
    const rect=svg.getBoundingClientRect(), mx=e.clientX-rect.left, my=e.clientY-rect.top;
    const x = (mx - 36)/(rect.width - 36 - 8) * (21 - (-7)) + (-7);
    const nearest = Math.round(x);
    const labels = seriesList.map((s,i)=>`${s.name}:${Math.round(s.data.find(p=>p.x===nearest).y*100)}%`).join('  ');
    tip.setAttribute('x', Math.min(rect.width-120, mx+8)); tip.setAttribute('y', 18);
    tip.textContent = `x=${nearest}  ${labels}`;
  });
}

/* ====== Critical days scanner (chronological) ====== */
function scanCritical(birthUTC, spanDays){
  const out=[];
  const startUTC = new Date(Date.UTC(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()));
  for(let i=0;i<spanDays;i++){
    const dUTC=new Date(startUTC.getTime()+i*86400000);
    const daysLived=Math.floor((dUTC - birthUTC)/86400000);
    const vals={}; for(const [k,p] of Object.entries(PERIODS)) vals[k]=bioVal(daysLived,p);
    const highs=Object.values(vals).filter(v=>v>0.85).length;
    const lows=Object.values(vals).filter(v=>v<-0.85).length;
    const crits=Object.values(vals).filter(v=>Math.abs(v)<0.02).length;

    const n=numerologyDay(birthUTC.getUTCFullYear(), birthUTC.getUTCMonth()+1, birthUTC.getUTCDate(),
                          dUTC.getUTCFullYear(), dUTC.getUTCMonth()+1, dUTC.getUTCDate());
    const numHit=(n.PD===1||n.PD===9);

    const moon=moonPhaseInfo(dUTC); const isNew=moon.phase.startsWith('New'); const isFull=moon.phase.startsWith('Full');

    let score=0, tags=[];
    if(crits>=2){score+=3; tags.push('multi-critical');}
    if(highs>=3){score+=2; tags.push('triple-high');}
    if(lows>=3){score+=2; tags.push('triple-low');}
    if((isNew||isFull) && (highs>=2||lows>=2)){score+=2; tags.push(isFull?'full+strong':'new+strong');}
    if(numHit && (highs>=2||lows>=2)){score+=1; tags.push(`PD${n.PD}+strong`);}

    if(score>=3){
      out.push({
        date:dUTC.toISOString().slice(0,10),
        label:(crits>=2?'üå´ ':'')+(highs>=3?'‚òÄÔ∏è ':'')+(lows>=3?'‚õà ':'')+(isFull?'üåï ':'')+(isNew?'üåë ':''),
        tags,
        top:Object.entries(vals).sort((a,b)=>Math.abs(b[1])-Math.abs(a[1])).slice(0,3)
            .map(([k,v])=>`${k} ${v>0?'+':''}${Math.round(v*100)}%`).join(', ')
      });
    }
  }
  // chronological order (per your request)
  out.sort((a,b)=> a.date.localeCompare(b.date));
  return out.slice(0,12);
}

/* ====== UI Pieces ====== */
function kpi(container, label, value, expl=''){
  const el = add(`<div class="k"><h4>${label}</h4><div class="v">${value}</div>${window.__exp && expl? `<div class="s">${expl}</div>`:''}</div>`);
  container.append(el);
}

/* ====== Main compute ====== */
function compute(){
  const dob=$('#dob').value; if(!dob){alert('Enter birth date');return;}
  const tob=$('#tob').value||'12:00';
  const tz=parseFloat($('#tz').value); $('#tzHint').textContent=`Using UTC${tz>=0?'+':''}${tz}`;

  const [Y,M,D]=dob.split('-').map(Number);
  const [h,m]=tob.split(':').map(Number);
  const birthUTC=new Date(Date.UTC(Y,M-1,D,h,m) - tz*3600000);

  /* General */
  const gen=$('#kpiGeneral'); gen.innerHTML='';
  const wd=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][new Date(Y,M-1,D).getDay()];
  const now=new Date(); const todayLocal=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const daysLived=Math.floor((Date.UTC(todayLocal.getFullYear(),todayLocal.getMonth(),todayLocal.getDate()) - birthUTC)/86400000);
  const age=now.getFullYear()-Y - ((now.getMonth()+1<M)||((now.getMonth()+1===M)&&(now.getDate()<D))?1:0);
  const nextB=new Date(now.getFullYear(),M-1,D); if(nextB<todayLocal) nextB.setFullYear(now.getFullYear()+1);
  const daysTo=Math.round((nextB - todayLocal)/86400000);
  const ssd=sunSignDecan(M,D), cz=chineseZodiac(Y), ns=nineStarKi(Y,M,D), sa=sajuYearPillar(Y),
        may=mayanFromGregorian(Y,M,D), lp=lifePath(Y,M,D), tc=tarotCards(Y,M,D),
        bornMoon=bornMoonPhase(Y,M,D);

  kpi(gen,'Birth weekday', wd, 'Baseline personal cadence');
  kpi(gen,'Age ‚Ä¢ Days lived', `${age} yrs ‚Ä¢ ${fmt(daysLived)}`, 'Context + cycle counter');
  const srWindow = Math.abs(daysTo)<=3 ? ' (solar-return window now)' : '';
  kpi(gen,'Next birthday', `${daysTo} days${srWindow}`, 'Proximity to reset themes');
  kpi(gen,'Sun sign', `${ssd.sign} ‚Ä¢ ${ssd.decan}`, `${ssd.element} ‚Ä¢ ${ssd.modality} ‚Äî ${ssd.meaning}`);
  kpi(gen,'Chinese year pillar', `${cz.yearPillar}`, `${cz.element} ${cz.animal} ‚Äî ${cz.meaning}`);
  kpi(gen,'Nine Star Ki', `${ns.number} ‚Ä¢ ${ns.element}`, ns.meaning);
  kpi(gen,'Saju (Year Pillar)', sa.yearPillar, sa.meaning);
  kpi(gen,'Mayan', `${may.tzolkin} ‚Ä¢ ${may.haab}`, 'Tone√óday-lord ‚Ä¢ solar context');
  kpi(gen,'Born moon phase', `${bornMoon.phase} ‚Ä¢ ${bornMoon.illumination}%`, 'Mood imprint at birth');
  kpi(gen,'Life Path ‚Ä¢ Tarot', `${lp} ‚Ä¢ ${tc.primary}`, `Companion: ${tc.companion}`);

  /* Today */
  const t=$('#kpiToday'); t.innerHTML='';
  const today=new Date(); const nday=numerologyDay(Y,M,D,today.getFullYear(),today.getMonth()+1,today.getDate());
  const moon=moonPhaseInfo(new Date(Date.UTC(today.getFullYear(),today.getMonth(),today.getDate())));
  const planetDay=['Sunday ‚òÄÔ∏è','Monday üåô','Tuesday ‚ôÇÔ∏è','Wednesday ‚òø','Thursday ‚ôÉ','Friday ‚ôÄÔ∏è','Saturday ‚ôÑ'][today.getDay()];

  const valsToday={}; for(const [k,p] of Object.entries(PERIODS)) valsToday[k]=bioVal(daysLived,p);
  const res = resonance(valsToday);
  const resTip = res.direction==='expansive' ? 'Lean into starts, pitches, and outward moves.' : 'Consolidate, finish, recover, and prep.';
  const bioTop = Object.entries(valsToday).sort((a,b)=>Math.abs(b[1])-Math.abs(a[1])).slice(0,3)
                   .map(([k,v])=>`${k} ${v>0?'+':''}${Math.round(v*100)}%`).join(', ');

  kpi(t,'Planetary day', planetDay, 'Day flavor (folk)');
  kpi(t,'Moon now', `${moon.phase} ‚Ä¢ ${moon.illumination}%`, 'Cadence & timing');
  kpi(t,'Personal Year ‚Ä¢ Month ‚Ä¢ Day', `${nday.PY} ‚Ä¢ ${nday.PM} ‚Ä¢ ${nday.PD}`, `${nday.yearTip}; today: ${nday.dayTip}`);
  kpi(t,'Cycle Resonance Score', `${res.score}% ‚Ä¢ ${res.direction}`, `${res.tip} ‚Ä¢ Top: ${bioTop}`);

  /* Charts */
  function makeSeries(keys){
    const arr=[]; for(let x=-7;x<=21;x++){ const d=daysLived+x; const p={x}; keys.forEach(k=>p[k]=bioVal(d,PERIODS[k])); arr.push(p); }
    return arr;
  }
  const A=makeSeries(['Physical','Emotional','Intellectual']), B=makeSeries(['Intuition','Aesthetic','Spiritual']);
  const pick=(arr,key)=>arr.map(p=>({x:p.x,y:p[key]}));
  renderChart($('#svgA'), [{name:'Physical',data:pick(A,'Physical')},{name:'Emotional',data:pick(A,'Emotional')},{name:'Intellectual',data:pick(A,'Intellectual')}]);
  renderChart($('#svgB'), [{name:'Intuition',data:pick(B,'Intuition')},{name:'Aesthetic',data:pick(B,'Aesthetic')},{name:'Spiritual',data:pick(B,'Spiritual')}]);

  /* Next Critical Days (chronological) */
  const crit=scanCritical(birthUTC, 90);
  const list=$('#critList'); list.innerHTML='';
  if(crit.length===0){
    list.append(add(`<div class="item"><div class="mut">No very-critical clusters detected in the next 90 days under strict rules.</div></div>`));
  }else{
    crit.forEach(c=>{
      list.append(add(`<div class="item">
        <div>
          <div class="date">${c.date} ${c.label}</div>
          <div class="mut">${c.top}</div>
        </div>
        <div>${c.tags.map(t=>`<span class="chip ${t.includes('low')?'bad':t.includes('critical')?'crit':'good'}">${t}</span>`).join(' ')}</div>
      </div>`));
    });
  }
}

/* ====== Handlers ====== */
$('#useBrowser').addEventListener('click', ()=>{
  const mins = -new Date().getTimezoneOffset();
  const hours = (mins/60);
  $('#tz').value = String(hours);
  $('#tzHint').textContent = `Using UTC${hours>=0?'+':''}${hours}`;
});
$('#run').addEventListener('click', compute);
$('#toggleExp').addEventListener('click', ()=>{ window.__exp=!window.__exp; compute(); });

/* First run with explanations on */
window.__exp=true;
compute();
</script>
</body>
</html>
